<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Ù†Ø¬Ù„Ø§Ø¡ Ø§Ù„ÙƒØ§Ø´Ù-GPT</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100dvh;
      font-family: Arial, sans-serif;
      background: url('https://i.pinimg.com/originals/6a/be/f6/6abef61ce92590dd27fe0867033983c9.jpg') no-repeat center center fixed;
      background-size: cover;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100dvh;
    }

    .header {
      position: sticky;
      top: 0;
      background-color: transparent;
      z-index: 1000;
      padding: 10px 0;
      transition: all 0.3s ease;
    }

    .header-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.3s ease;
    }

    .header img {
      width: 40px;
      height: 40px;
      margin-bottom: 5px;
      transition: all 0.3s ease;
    }

    .header h1 {
      color: white;
      margin: 0;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .header.shrink .header-inner {
      flex-direction: row;
      justify-content: center;
      gap: 10px;
    }

    .header.shrink img {
      width: 25px;
      height: 25px;
      margin-bottom: 0;
    }

    .header.shrink h1 {
      font-size: 14px;
    }

    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 10px 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 80%;
      padding: 10px 15px;
      border-radius: 15px;
      line-height: 1.5;
      word-wrap: break-word;
      font-size: 16px;
    }

    .user {
      align-self: flex-end;
      background-color: #056162;
      color: white;
    }

    .bot {
      align-self: flex-start;
      background-color: #262d31;
      color: white;
    }

    .input-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      padding: 10px;
      background-color: #1e1e1e;
      border-top: 1px solid #333;
      gap: 10px;
      width: 100%;
      max-width: 100vw;
    }

    #user-input {
      flex-grow: 1;
      flex-shrink: 1;
      min-width: 50px;
      max-width: 100%;
      padding: 16px 20px;
      border: none;
      border-radius: 20px;
      background-color: #2a2f32;
      color: white;
      font-size: 16px;
    }

    .input-container button {
      flex-shrink: 0;
      white-space: nowrap;
      padding: 12px 16px;
      border: none;
      border-radius: 20px;
      background-color: #056162;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    .quick-question {
      display: flex;
      justify-content: center;
      margin: 10px;
    }

    .quick-question button {
      background-color: #333;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 15px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-inner">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg" alt="ChatGPT">
        <h1>Ù†Ø¬Ù„Ø§Ø¡ Ø§Ù„ÙƒØ§Ø´Ù-GPT</h1>
      </div>
    </div>

    <div class="quick-question">
      <button onclick="sendQuickQuestion()">Ø§Ø¯ÙŠÙ†ÙŠ Ø£Ù…Ø«Ù„Ø© Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù„ÙŠ Ù…Ù…ÙƒÙ† Ø§Ø­ØªØ§Ø¬ Ø§Ø¹Ø±ÙÙ‡Ø§ Ù…Ù†ÙƒØŸ</button>
    </div>
    <div id="chat-box" class="chat-box"></div>
    <div class="input-container">
      <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeydown="if(event.key==='Enter') sendMessage()">
      <input type="file" id="image-input" accept="image/*" capture="environment" style="display: none;">
      <button id="send-btn" onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
      <button id="camera-btn" style="display: none;">ğŸ“· Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="confirm-btn" style="display: none;">âœ… ØªØ£ÙƒÙŠØ¯</button>
      <button id="retry-btn" style="display: none;">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDhdID2wAdkpl-Hc-8mWvMz83PNfAgRto8",
      authDomain: "kid-id.firebaseapp.com",
      databaseURL: "https://kid-id-default-rtdb.firebaseio.com",
      projectId: "kid-id",
      storageBucket: "kid-id.appspot.com",
      messagingSenderId: "921217378956",
      appId: "1:921217378956:android:6e9c8d7dedb8e05f3da9a9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const chatBox = document.getElementById("chat-box");
    let stage = "idle";
    let currentUploadKey = null;
    let openaiApiKey = null;

    // ØªØ¹Ø±ÙŠÙ mainCollection
    const mainCollection = "1";

    let applicationData = {};
    let currentQuestionIndex = 0;
    const questions = [
      {key: "studentName", text: "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠØŸ"},
      {key: "motherName", text: "Ø§Ø³Ù… Ø§Ù„Ø£Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ"},
      {key: "fatherJob", text: "ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£Ø¨ØŸ"},
      {key: "motherJob", text: "ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£Ù…ØŸ"},
      {key: "studentNID", text: "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù„Ù„Ø·ÙÙ„ Ù…Ù† Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ØŸ"},
      {key: "fatherNID", text: "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù„Ù„Ø£Ø¨ØŸ"},
      {key: "motherNID", text: "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù„Ù„Ø£Ù…ØŸ"},
      {key: "motherPhone", text: "Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø£Ù…ØŸ"},
      {key: "fatherPhone", text: "Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø£Ø¨ØŸ"},
      {key: "emergencyPhone", text: "Ø±Ù‚Ù… Ø·ÙˆØ§Ø±Ø¦ Ø§Ø­ØªÙŠØ§Ø·ÙŠØŸ"},
      {key: "location", text: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø´ÙƒÙ„ ØªÙØµÙŠÙ„ÙŠØŸ"},
      {key: "details", text: "Ù‡Ù„ ÙÙŠ Ø§ÙŠ ØªÙØ§ØµÙŠÙ„ ØªØ­Ø¨ ØªØ¨Ù„Øº Ø¨ÙŠÙ‡Ø§ Ù„Ø¬Ù†Ø© Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø§ÙŠ ØªÙØ§ØµÙŠÙ„ ØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙÙ‡Ø§ Ù‡Ù†Ø§ØŸ"},
      {key: "HowknowUs", text: "Ø¹Ø±ÙØªÙ†Ø§Ø§Ø²Ø§ÙŠØŸ"},

      {key: "studentPhoto", text: "ØªÙ…Ø§Ù… Ø¯Ù„ÙˆÙ‚ØªÙŠ Ø§Ù†Ø§ ÙØ¹Ù„ØªÙ„Ùƒ Ø²Ø±Ø§Ø± Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ùˆ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØµÙˆØ± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙÙŠ Ø¥Ø¶Ø§Ø¦Ø© ÙˆØ§Ø¶Ø­Ù‡ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† ÙˆØ§Ø¶Ø­Ù‡"},
      {key: "parentsIDPhoto", text: "Ø§Ø³ØªØ£Ø°Ù†Ùƒ ØªØ­Ø· Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø¨ Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ù…  ØªØ­ØªÙ‡Ù… Ø´Ù‡Ø§Ø¯Ø© Ù…ÙŠÙ„Ø§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ùˆ ØªØªØ£ÙƒØ¯ Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙƒÙˆÙ† Ø¸Ø§Ù‡Ø±Ù‡ Ùˆ ØªÙ„ØªÙ‚Ø· ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ù‡"}
    ];

    function loadOpenAIKey() {
      const apiKeyRef = db.ref(`${mainCollection}/splashActivity/mainActivity`);
      apiKeyRef.once('value').then(snapshot => {
        openaiApiKey = snapshot.val();
        if (!openaiApiKey) {
          console.error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ OpenAI API ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
          appendMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙØªØ§Ø­ API. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.", "bot", true);
        }
      }).catch(error => {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙØªØ§Ø­ API:", error);
        appendMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙØªØ§Ø­ API. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.", "bot", true);
      });
    }

    loadOpenAIKey();

    const header = document.querySelector('.header');
    const chatBoxDiv = document.querySelector('.chat-box');

    function updateHeaderState() {
      const distanceFromBottom = chatBoxDiv.scrollHeight - chatBoxDiv.scrollTop - chatBoxDiv.clientHeight;
      if (distanceFromBottom > 100) {
        header.classList.add('shrink');
      } else {
        header.classList.remove('shrink');
      }
    }

    chatBoxDiv.addEventListener('scroll', updateHeaderState);

    function appendMessage(text, className, typing = false) {
      const msg = document.createElement("div");
      msg.className = `message ${className}`;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;

      const htmlLinkRegex = /<a\s+href="(https?:\/\/[^"]+)"[^>]*>(.*?)<\/a>/gi;
      text = text.replace(htmlLinkRegex, (_, url, label) => `[${label}](${url})`);

      const parts = [];
      let lastIndex = 0;
      const linkRegex = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
      let match;
      while ((match = linkRegex.exec(text)) !== null) {
        if (match.index > lastIndex) {
          parts.push({ type: "text", content: text.slice(lastIndex, match.index) });
        }
        parts.push({ type: "link", label: match[1], url: match[2] });
        lastIndex = linkRegex.lastIndex;
      }
      if (lastIndex < text.length) {
        parts.push({ type: "text", content: text.slice(lastIndex) });
      }

      if (typing) {
        const tempSpan = document.createElement("span");
        msg.appendChild(tempSpan);

        let partIndex = 0;
        let charIndex = 0;

        const interval = setInterval(() => {
          if (partIndex >= parts.length) {
            clearInterval(interval);
            return;
          }

          const current = parts[partIndex];

          if (current.type === "text") {
            if (charIndex < current.content.length) {
              tempSpan.innerHTML += current.content[charIndex];
              charIndex++;
            } else {
              partIndex++;
              charIndex = 0;
            }
          } else if (current.type === "link") {
            const link = document.createElement("a");
            link.href = current.url;
            link.target = "_blank";
            link.style.color = "#4fc3f7";
            link.textContent = current.label || "Ø§Ø¶ØºØ· Ù‡Ù†Ø§";
            msg.appendChild(link);
            partIndex++;
          }

          chatBox.scrollTop = chatBox.scrollHeight;
        }, 20);
      } else {
        let finalHTML = text.replace(linkRegex, '<a href="$2" target="_blank" style="color:#4fc3f7;">$1</a>');
        msg.innerHTML = finalHTML;
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendQuickQuestion() {
      const question = "Ø§Ø¯ÙŠÙ†ÙŠ Ø£Ù…Ø«Ù„Ø© Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù„ÙŠ Ù…Ù…ÙƒÙ† Ø§Ø­ØªØ§Ø¬ Ø§Ø¹Ø±ÙÙ‡Ø§ Ù…Ù†ÙƒØŸ";
      appendMessage(question, "user");
      document.querySelector(".quick-question").style.display = "none";
      fetchAIReply(question).then(reply => appendMessage(reply, "bot", true));
    }

    function sendMessage() {
      const input = document.getElementById("user-input");
      const message = input.value.trim();
      if (!message) return;
      appendMessage(message, "user");
      input.value = "";
      handleMessage(message);
    }

    let complaintStage = null;
    let currentComplaintId = null;

    function handleMessage(message) {
      db.ref(`${mainCollection}/autoChatOn`).once("value").then(snapshot => {
        const isActive = snapshot.val();
        if (isActive !== true) {
          appendMessage("ÙˆØ±Ø¯ÙŠØªÙŠ Ø®Ù„ØµØª Ù…Ø´ Ù‡Ø±Ø¯ Ø¯Ù„ÙˆÙ‚ØªÙŠ", "bot", true);
          return;
        }

        if (complaintStage === "awaitingStudentName") {
          db.ref(`${mainCollection}/FeedbackCritical`).child(currentComplaintId).update({
            studentName: message
          });
          appendMessage("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù„Ù„ØªÙˆØ§ØµÙ„.", "bot", true);
          complaintStage = "awaitingPhone";
          return;
        }

        if (complaintStage === "awaitingPhone") {
          db.ref(`${mainCollection}/FeedbackCritical`).child(currentComplaintId).update({
            parentPhone: message
          });
          appendMessage("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙƒÙ… Ù‚Ø±ÙŠØ¨Ù‹Ø§ Ù…Ù† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¤Ø³Ø³Ø©.", "bot", true);
          complaintStage = null;
          currentComplaintId = null;
          return;
        }

        fetchAIReply(message).then(reply => {
          if (reply.toLowerCase().includes("ØªÙ‚ØµÙŠØ±::")) {
            appendMessage("Ù†Ø£Ø³Ù Ø¹Ù„Ù‰ Ù…Ø§ Ø­Ø¯Ø«ØŒ ÙˆØªÙ… ØªØµØ¹ÙŠØ¯ Ø§Ù„Ø£Ù…Ø± Ø¥Ù„Ù‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ù„Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡.", "bot", true);
            appendMessage("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…ØªØ¶Ø±Ø±.", "bot", true);

            const complaintRef = db.ref(`${mainCollection}/FeedbackCritical`);
            const now = new Date();
            const complaintId = now.getTime();

            currentComplaintId = complaintId;
            complaintStage = "awaitingStudentName";

            complaintRef.child(complaintId).set({
              complaintMessage: message,
              date: now.toLocaleDateString("ar-EG"),
              time: now.toLocaleTimeString("ar-EG"),
              status: "pending"
            });

            return;
          }

          if (reply.toLowerCase().includes("Ø§Ø³ØªÙØ³Ø§Ø±::")) {
            appendMessage("Ø§Ø­ÙŠÙŠÙƒ Ø³Ø¤Ø§Ù„Ùƒ Ù…Ø´ Ø¹Ø§Ø±Ù Ø§Ø¬Ø§Ø¨ØªØ© Ùˆ Ø¹Ø´Ø§Ù† ÙƒØ¯Ù‡ Ù‡Ø±Ø¬Ø¹ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ùˆ Ø§Ø³Ø£Ù„Ù‡Ù… Ø¹Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø¯Ù‡ Ùˆ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡ Ù„Ùˆ Ø³Ø£Ù„ØªÙ†ÙŠ Ù†ÙØ³ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ÙƒØ±Ù‡ Ù‡Ø±Ø¯ Ø¹Ù„ÙŠÙƒ", "bot", true);

            const newQRef = db.ref(`${mainCollection}/NewQuestions`);
            newQRef.once("value").then(snapshot => {
              const count = snapshot.numChildren() + 1;
              newQRef.child(String(count)).set(message);
            });

            return;
          }

          if (reply.toLowerCase().includes("Ø§Ø´ØªØ±Ø§Ùƒ::")) {
            reply = reply.replace("Ø§Ø´ØªØ±Ø§Ùƒ::", "").trim();
            appendMessage(reply, "bot", true);
            appendMessage(" Ù‡ÙŠÙƒÙˆÙ† Ù…Ø·Ù„ÙˆØ¨ ØªØ¬Ù‡Ø² Ø¬Ù†Ø¨Ùƒ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ùˆ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ù„Ù„Ø§Ø¨ Ùˆ Ø§Ù„Ø§Ù… 3 Ø§Ø±Ù‚Ø§Ù… Ù„Ù„ØªÙˆØ§ØµÙ„ Ùˆ ÙŠÙƒÙˆÙ† Ø§Ù„Ø·ÙÙ„ Ø¬Ù†Ø¨Ùƒ Ø¹Ø´Ø§Ù† Ù‡Ø·Ù„Ø¨ Ù…Ù†Ùƒ ØªØµÙˆØ±Ø© Ùˆ Ø¨ÙƒØ¯Ø© Ù‡ØªÙƒÙˆÙ† Ø§Ø´ØªØ±ÙƒØª Ø¨Ø´ÙƒÙ„ Ø±Ø³Ù…ÙŠ ÙÙŠ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ùˆ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‡ØªØ®ØªØ§Ø± 3 Ø§ÙŠØ§Ù… Ùˆ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ù„ÙŠ Ù‡ØªØ¬ÙŠØ¨ ÙÙŠÙ‡ Ø§Ù„Ø·ÙÙ„ ÙÙŠ Ø§ÙŠ ÙˆÙ‚Øª Ù…Ù†Ø§Ø³Ø¨ Ù„ÙŠÙƒ Ù…Ù† 9 Ø§Ù„ØµØ¨Ø­ Ù„Ø­Ø¯ 9 Ø¨Ù„ÙŠÙ„ ÙƒÙ„ Ù…Ø±Ù‡ Ø§Ù†Øª Ø§Ù„Ù„ÙŠ Ø¨ØªØ®ØªØ§Ø± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù„ÙŠ ÙØ§Ø¶ÙŠ ÙÙŠÙ‡ ÙŠÙˆÙ…ÙŠØ§ Ø§Ø¨Ù†Ùƒ Ø¨ÙŠÙƒÙˆÙ† Ù„ÙŠÙ‡ Ù…Ø³Ø§Ø¹Ø¯ Ø®Ø§Øµ Ù…Ù† ÙØ±ÙŠÙ‚Ù†Ø§ Ø¨Ø³ Ø®Ù„ÙŠ Ø¨Ø§Ù„Ùƒ Ù„Ùˆ Ø§ØªØ£Ø®Ø±Øª Ø¹Ù† ÙˆÙ‚Øª Ø§ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø¨ÙŠØªØ¶Ø§Ù Ø¹Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¬Ù„Ø³Ø© Ø§Ø³ØªØ¶Ø§ÙÙ‡ 100Ø¬Ù†ÙŠØ© ÙˆÙ„Ùˆ Ø§ØªØ£Ø®Ø±Øª Ø¹Ù† Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·ÙÙ„ Ø¹Ù…ÙˆÙ…Ø§ Ø¹Ù„ÙŠ Ù…Ø¯Ø§Ø± Ø§Ù„ÙŠÙˆÙ… ÙƒÙ„ Ø³Ø§Ø¹Ù‡ Ø¨ØªØ²ÙˆØ¯ 50Ø¬Ù†ÙŠØ© Ø¹Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ø§ÙŠØ§ Ù‡Ø¨Ø¹ØªÙ„Ùƒ Ù„ÙŠÙ†Ùƒ Ù‡ØªØ¯ÙˆØ³ Ø¹Ù„ÙŠÙ‡ Ø¹Ø´Ø§Ù† ØªØ­Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¤Ø³Ø³Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙŠÙƒÙˆÙ† Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ø¨Ø§Ø¹ÙŠ Ø§Ù„Ù„ÙŠ Ù‡ØªÙƒØªØ¨Ù‡ÙˆÙ„ÙŠ Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ø¨ØªØ§Ø¹Ù‡ Ùˆ Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ³Ù…Ø­Ù„Ùƒ ØªØªØ§Ø¨Ø¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ùˆ ØªØ­Ø¯Ø¯ Ù…ÙƒØ§Ù† Ø§Ø¨Ù†Ùƒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© ÙˆÙ„Ø§ Ù„Ø³Ù‡ Ù„Ùˆ ÙƒÙ„ Ø­Ø§Ø¬Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ø±ÙÙ†ÙŠ Ø§Ù†Ùƒ Ù…Ø³ØªØ¹Ø¯ ", "bot", true);
            if (stage !== "check-docs" && stage !== "application") {
              stage = "check-docs";
            }
            return;
          }

          if (reply.toLowerCase().includes("Ø§Ù„ÙˆØ±Ù‚::")) {
            if (reply.toLowerCase().includes("Ø§Ù„ÙˆØ±Ù‚::Ù„Ø§")) {
              stage = "idle";
              appendMessage("Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø´Ù‡Ø§Ø¯Ø© Ù…ÙŠÙ„Ø§Ø¯ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù„Ù„Ø£Ø¨ ÙˆØ§Ù„Ø£Ù…ØŒ ØµÙˆØ± Ø´Ø®ØµÙŠØ© Ù„Ù„Ø·ÙÙ„ØŒ Ø¥Ø«Ø¨Ø§Øª ÙˆØ¸ÙŠÙØ© Ù„Ù„Ø£Ø¨ ÙˆØ§Ù„Ø£Ù…ØŒ Ø£Ø±Ù‚Ø§Ù… ØªÙˆØ§ØµÙ„.", "bot", true);
            } else if (reply.toLowerCase().includes("Ø§Ù„ÙˆØ±Ù‚::Ù†Ø¹Ù…")) {
              stage = "application";
              currentQuestionIndex = 0;
              applicationData = {};
              askNextQuestion();
            }
            return;
          }

          if (stage === "application") {
            const q = questions[currentQuestionIndex];
            applicationData[q.key] = message;
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
              askNextQuestion();
            } else {
              saveApplication();
            }
          } else {
            appendMessage(reply, "bot", true);
          }
        });
      });
    }

    function askNextQuestion() {
      const q = questions[currentQuestionIndex];

      if (q.key === "studentPhoto" || q.key === "parentsIDPhoto") {
        currentUploadKey = q.key;
        appendMessage(q.text + " (Ø§Ø®ØªØ§Ø±ÙŠ ØµÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)", "bot", true);
        document.getElementById("send-btn").style.display = "none";
        document.getElementById("camera-btn").style.display = "inline-block";
        return;
      }

      appendMessage(q.text, "bot", true);
    }

    function saveApplication() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      const counterKey = `${year}-${month}-${day}`;

      const counterRef = db.ref(`${mainCollection}/ApplicationIDCounter`).child(counterKey);

      counterRef.transaction(currentValue => {
        return (currentValue || 0) + 1;
      }, (error, committed, snapshot) => {
        if (error || !committed) {
          appendMessage("Ø­ØµÙ„Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ.", "bot", true);
          return;
        }

        const counter = snapshot.val();
        const entryId = `${String(counter).padStart(2, '0')}-${day}-${month}-${year}`;
        registerStudent(entryId);
      });
    }

    function registerStudent(entryId) {
      const submissionsRef = db.ref(`${mainCollection}/UnderReview`);
      const usersRef = db.ref(`${mainCollection}/users`);

      const studentName = applicationData.studentName || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
      const phoneMother = applicationData.motherPhone || "";
      const phoneFather = applicationData.fatherPhone || "";
      const phone3 = applicationData.emergencyPhone || "";
      const fatherNID = applicationData.fatherNID || "";
      const motherNID = applicationData.motherNID || "";
      const studentNID = applicationData.studentNID || "";
      const fatherJob = applicationData.fatherJob || "";
      const motherJob = applicationData.motherJob || "";
      const location = applicationData.location || "";
      const details = applicationData.details || "";
      const HowknowUs = applicationData.HowknowUs || "";

      const fatherName = studentName.split(" ").slice(1).join(" ");

      submissionsRef.child(entryId).set({
        kidId: entryId,
        kidName: studentName,
        phoneFather: phoneFather,
        phoneMother: phoneMother,
        phone3: phone3,
        NationalID: studentNID,
        fatherNID: fatherNID,
        motherNID: motherNID,
        fatherJob: fatherJob,
        motherJob: motherJob,
        fatherName: fatherName,
        isInClass: false,
        location: location,
        details: details,
        HowknowUs: HowknowUs,
        studentPhoto: applicationData.studentPhoto || "",
        parentsIDPhoto: applicationData.parentsIDPhoto || "",
      });

      usersRef.child(studentNID).set({
        id: studentNID,
        name: studentName,
        KidId: entryId,
        isAccepted: false
      });

      appendMessage(
        `ğŸ‰ Ø·Ù„Ø¨Ùƒ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ù…Ù† ÙØ±ÙŠÙ‚ Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙÙŠ Ù…Ø¤Ø³Ø³Ø© Ù†Ø¬Ù„Ø§Ø¡ Ø§Ù„ÙƒØ§Ø´Ù ğŸ‰

      Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚:
      ğŸ‘¶ Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„: ${applicationData.studentName}
      ğŸ†” ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentNID}

      ğŸ“¸ Ø®Ø¯ Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø© Ø¯Ù„ÙˆÙ‚ØªÙŠ Ù„Ø£Ù† Ø¯ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„ÙŠ Ù‡ØªØ¯Ø®Ù„ Ø¨ÙŠÙ‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚

      Ø¨Ù…Ø¬Ø±Ø¯ Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù„ØªØ­Ø§Ù‚ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¹Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©ØŒ ÙˆÙ‡ÙŠØªÙ… Ø¥ÙØ§Ø¶Ø© Ø¨ØµÙ…Ø© Ø¥ØµØ¨Ø¹ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ¯Ø®Ù„ Ø¨ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©
      ØªÙ‚Ø¯Ø± ØªØ³Ø£Ù„Ù†ÙŠ Ø¨ÙƒØ±Ù‡ Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ØŒ ÙˆÙ„Ùˆ ØªÙ… Ù‚Ø¨ÙˆÙ„Ù‡ Ù‡Ù‚ÙˆÙ„Ùƒ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¬Ø§ÙŠØ©

      â¬‡ï¸ ØªÙ‚Ø¯Ø± ØªØ­Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ù…Ù† Ø§Ù„Ù„ÙŠÙ†Ùƒ Ø¯Ù‡:
      [Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚](https://t.me/+iU2p-U3Pin83Y2M0)

      âš ï¸ Ù…Ù…ÙƒÙ† ÙŠÙˆØµÙ„Ùƒ ØªØ­Ø°ÙŠØ± ÙˆØ§Ù†Øª Ø¨ØªØ«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      Ù…Ø§ ØªÙ‚Ù„Ù‚Ø´ØŒ Ø¯Ù‡ Ø·Ø¨ÙŠØ¹ÙŠ Ø¹Ù„Ø´Ø§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Google Play
      Ø§Ø®ØªØ§Ø± "ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„" ÙˆÙ‡ØªÙ‚Ø¯Ø± ØªØ³ØªØ®Ø¯Ù…Ù‡ Ø¹Ø§Ø¯ÙŠØŒ Ù„Ùˆ ÙˆØ§Ø¬Ù‡ØªÙƒ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù†ÙˆØ±Ù†Ø§ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª ÙˆØ¥Ø­Ù†Ø§ Ù‡Ù†Ø³Ø§Ø¹Ø¯Ùƒ`,
        "bot",
        true
      );

      stage = "idle";
      applicationData = {};
    }

    async function fetchAIReply(message) {
      try {
        if (!openaiApiKey) {
          await new Promise(resolve => setTimeout(resolve, 1000)); // Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ±
          if (!openaiApiKey) {
            return "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙØªØ§Ø­ APIØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰...";
          }
        }

        const promptSnapshot = await db.ref(`${mainCollection}/Prompt/apiPrompt`).once('value');
        const systemMessage = promptSnapshot.val() || "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ";

        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${openaiApiKey}`
          },
          body: JSON.stringify({
            model: "gpt-4o",
            messages: [
              {role: "system", content: systemMessage},
              {role: "user", content: message}
            ]
          })
        });

        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¬Ø§Ø¨Ø© API: ${response.status}`);
        }

        const data = await response.json();
        return data.choices?.[0]?.message?.content || "Ù…Ø¹Ø±ÙØªØ´ Ø£Ø±Ø¯ Ø¯Ù„ÙˆÙ‚ØªÙŠØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ.";
      } catch (err) {
        console.error("Error in fetchAIReply:", err);
        return `ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ${err.message}`;
      }
    }

    // Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØºÙŠØ±Ù‡Ø§) ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±
    const cameraBtn = document.getElementById("camera-btn");
    const imageInput = document.getElementById("image-input");
    const confirmBtn = document.getElementById("confirm-btn");
    const retryBtn = document.getElementById("retry-btn");
    const sendBtn = document.getElementById("send-btn");

    cameraBtn.addEventListener("click", () => {
      imageInput.click();
    });

    imageInput.addEventListener("change", () => {
      if (imageInput.files.length > 0) {
        appendMessage("ğŸ“¸ ØµÙˆØ±Ø© ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§ (Ù„Ù… ØªØªÙ… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©)", "user");
        cameraBtn.style.display = "none";
        confirmBtn.style.display = "inline-block";
        retryBtn.style.display = "inline-block";
      }
    });

    confirmBtn.addEventListener("click", () => {
      const file = imageInput.files[0];
      if (!file || !currentUploadKey) {
        appendMessage("âŒ Ù…ÙÙŠØ´ ØµÙˆØ±Ø© Ø£Ùˆ Ù…ÙÙŠØ´ Ù…ÙØªØ§Ø­ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„ØµÙˆØ±Ø©", "bot");
        return;
      }

      const now = new Date();
      const timestamp = now.getTime();
      const storageRef = storage.ref(`studentForms/${currentUploadKey}_${timestamp}.jpg`);

      const uploadTask = storageRef.put(file);

      uploadTask.on('state_changed',
        null,
        (error) => {
          appendMessage("âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø¬Ø±Ø¨ÙŠ ØªØ§Ù†ÙŠ", "bot");
          console.error(error);
        },
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
            applicationData[currentUploadKey] = downloadURL;

            appendMessage("âœ… Ø§Ù„ØµÙˆØ±Ø© Ø§ØªØ±ÙØ¹Øª Ø¨Ù†Ø¬Ø§Ø­", "bot");

            confirmBtn.style.display = "none";
            retryBtn.style.display = "none";
            sendBtn.style.display = "inline-block";
            currentUploadKey = null;
            currentQuestionIndex++;

            if (currentQuestionIndex < questions.length) {
              askNextQuestion();
            } else {
              saveApplication();
            }
          });
        }
      );
    });

    retryBtn.addEventListener("click", () => {
      appendMessage("ğŸ” Ø§Ø®ØªØ§Ø±ÙŠ ØµÙˆØ±Ø© Ù…Ù† Ø¬Ø¯ÙŠØ¯", "bot");
      imageInput.click();
    });

    const originalAppendMessage = appendMessage;
    appendMessage = function(text, className, typing = false) {
      originalAppendMessage(text, className, typing);
      if (className === "bot" && text.toLowerCase().includes("Ù‚Ø±Ø£Øª")) {
        sendBtn.style.display = "none";
        cameraBtn.style.display = "inline-block";
      }
    }

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.addEventListener('load', () => {
      setTimeout(() => {
        appendMessage("Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡ Ø§Ù„Ø°ÙƒÙŠÙ‡ ÙÙŠ Ù…Ø¤Ø³Ø³Ø© Ù†Ø¬Ù„Ø§Ø¡ Ø§Ù„ÙƒØ§Ø´ÙØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ", "bot", true);
      }, 1000);
    });
  </script>
</body>
</html>

